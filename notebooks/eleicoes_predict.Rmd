---
title: "R Notebook"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(gridExtra)
library(tidyverse)
library(lattice)
library(GGally)
library(here)
library(grid)

theme_set(theme_bw())
```

# Data Overview

## Loading Data

```{r}
eleicoes_data <- readr::read_csv(
  here::here('data/eleicoes_2006_e_2010.csv'), 
  local=readr::locale("br"),
  col_types = cols(
    ano = col_integer(),
    sequencial_candidato = col_character(),
    quantidade_doacoes = col_integer(),
    quantidade_doadores = col_integer(),
    total_receita = col_double(),
    media_receita = col_double(),
    recursos_de_outros_candidatos.comites = col_double(),
    recursos_de_pessoas_fisicas = col_double(),
    recursos_de_pessoas_juridicas = col_double(),
    recursos_proprios = col_double(),
    `recursos_de_partido_politico` = col_double(),
    quantidade_despesas = col_integer(),
    quantidade_fornecedores = col_integer(),
    total_despesa = col_double(),
    media_despesa = col_double(),
    votos = col_integer(),
    .default = col_character()))
```

```{r}
eleicoes_data %>% 
  mutate(nome = toupper(nome),
         recursos_totais = recursos_de_pessoas_fisicas +
                           recursos_de_outros_candidatos.comites +
                           recursos_de_pessoas_juridicas +
                           recursos_proprios,
         sexo = toupper(sexo),
         grau = toupper(grau),
         nome = toupper(nome),
         cargo = toupper(cargo),
         ocupacao = toupper(ocupacao),
         partido = toupper(partido),
         estado_civil = toupper(estado_civil)) %>%
  mutate(uf = as.factor(uf),
         nome = as.factor(nome),
         sexo = as.factor(sexo),
         grau = as.factor(grau),
         nome = as.factor(nome),
         cargo = as.factor(cargo),
         partido = as.factor(partido),
         ocupacao = as.factor(ocupacao),
         estado_civil = as.factor(estado_civil),
         sequencial_candidato = as.numeric(sequencial_candidato)) -> eleicoes_data

eleicoes_data %>% 
  glimpse()

```


## Data Exploration

```{r}
eleicoes_data %>%
  filter(ano == 2006) %>%
  group_by(partido) %>%
  summarize(n = n()) %>%
  ggplot(aes(reorder(partido,n), n)) +
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1)) +
  scale_y_continuous(limits = c(0,350)) +
  labs(x="Political Party",
       title="2006 elections",
       y="Absolute Frequency") -> p1

eleicoes_data %>%
  filter(ano == 2010) %>%
  group_by(partido) %>%
  summarize(n = n()) %>%
  ggplot(aes(reorder(partido,n), n)) +
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90,
                                   hjust = 1)) +
  scale_y_continuous(limits = c(0,350)) +
  labs(x="Political Party",
       title="2010 elections",
       y="Absolute Frequency") -> p2

grid.arrange(p1, p2, ncol=1)
```

```{r}
eleicoes_data %>%
  ggplot(aes(total_receita)) +
  geom_histogram(bins = 30) +
  labs(x="Total Revenue",
       y="Absolute Frequency") +
  facet_grid(. ~ ano)
```

```{r}
eleicoes_data %>%
  ggplot(aes(media_receita)) +
  geom_histogram(bins = 30) +
  labs(x="Mean Revenue",
       y="Absolute Frequency") +
  facet_grid(. ~ ano)
```

```{r}
eleicoes_data %>%
  ggplot(aes(total_despesa)) +
  geom_histogram(bins = 30) +
  labs(x="Total Expenditure",
       y="Absolute Frequency") +
  facet_grid(. ~ ano)
```

```{r}
eleicoes_data %>%
  ggplot(aes(media_despesa)) +
  geom_histogram(bins = 30) +
  labs(x="Mean Expenditure",
       y="Absolute Frequency") +
  facet_grid(. ~ ano)
```

```{r}
eleicoes_data %>%
  ggplot(aes(recursos_proprios)) +
  geom_histogram(bins = 30) +
  labs(x="Total Revenue",
       y="Absolute Frequency") +
  facet_grid(. ~ ano)
``` 

```{r}
eleicoes_data %>%
  mutate(ano = as.factor(ano)) %>%
  group_by(estado_civil, ano) %>%
  summarize(n = n()) %>%
  ggplot(aes(reorder(estado_civil,n), n,
             fill= ano)) +
  geom_bar(stat = "identity",
           position = position_dodge(width = 0.5)) + 
  labs(x="Marital status", 
       y="Absolute Frequency") +
  guides(fill = guide_legend(title = "year")) +
  coord_flip()
```

```{r}
eleicoes_data %>%
  mutate(ano = as.factor(ano)) %>%
  group_by(grau, ano) %>%
  summarize(n = n()) %>%
  ggplot(aes(reorder(grau,n), n,
             fill= ano)) +
  geom_bar(stat = "identity",
           position = position_dodge(width = 0.5)) + 
  labs(x="Education level", 
       y="Absolute Frequency") +
  guides(fill = guide_legend(title = "year")) +
  coord_flip()
```

```{r}
eleicoes_data %>%
  group_by(sexo, ano) %>%
  summarize(n = n()) %>%
  ggplot(aes(reorder(sexo,n), n)) +
  geom_bar(stat = "identity") + 
  labs(x="Gender", 
       y="Absolute Frequency") +
  facet_grid(. ~ano)
```

```{r}
require(GGally)

eleicoes_data %>% 
  filter(ano == 2006) %>%
  select(-partido,
         -uf,-nome,
         -estado_civil,
         -ocupacao,-ano,
         -cargo,-grau,-sexo) %>%
  na.omit() %>%
  ggcorr(palette = "RdBu",
         color = "grey50",
         label = TRUE, hjust = 1,
         label_size = 3, size = 4,
         nbreaks = 5, layout.exp = 7) +
  ggtitle("Correlation plot for 2006 elections")
```

```{r}
require(GGally)

eleicoes_data %>% 
  filter(ano == 2010) %>%
  select(-partido,
         -uf,-nome,
         -estado_civil,
         -ocupacao,-ano,
         -cargo,-grau,-sexo) %>%
  na.omit() %>%
  ggcorr(palette = "RdBu",
         color = "grey50",
         label = TRUE, hjust = 1,
         label_size = 3, size = 4,
         nbreaks = 5, layout.exp = 7) +
  ggtitle("Correlation plot for 2010 elections")
```


## Should we use all variables?

#### A multivariate linear regression model made with all variables wouldn't be feasible

* **cargo** is a one level factor and for that reason we must refrain from using it in our regression.
* **sequencial_candidato** isn't meaningful at all as the correlogram clearly showed

<br>

***

<br>

# Linear Model for 2006 elections

<br>

## Split Data for Cross Validation

```{r}
eleicoes_data %>% ## Put numeric predictor variables on same scale 
   filter(ano == 2006) %>%
   mutate_at(.vars = vars(quantidade_doacoes,
                          quantidade_doadores,
                          recursos_totais,
                          total_receita,
                          media_receita,
                          sequencial_candidato,
                          recursos_de_outros_candidatos.comites,
                          recursos_de_pessoas_fisicas,
                          recursos_de_pessoas_juridicas,
                          recursos_proprios,
                          recursos_de_partido_politico,
                          quantidade_despesas,
                          quantidade_fornecedores,
                          total_despesa,
                          media_despesa),
             .funs = funs(as.numeric(scale(.)))) -> data_scaled_2006

data_scaled_2006 %>%
  sample_n(5)
```

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

## Adding surrogate key to dataframe
data_scaled_2006$id <- 1:nrow(data_scaled_2006)

data_scaled_2006 %>% 
  dplyr::sample_frac(.5) -> train_data_2006

cat("#### Train Data ",
    "\n##### Observations: ",nrow(train_data_2006),
    "\n##### Variables: ",ncol(train_data_2006))
```

<br>

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

dplyr::anti_join(data_scaled_2006, 
                 train_data_2006, 
                 by = 'id') -> intermediate_data

intermediate_data %>% 
  dplyr::sample_frac(.5) -> test_data_2006

cat("#### Test Data ",
    "\n##### Observations: ",nrow(test_data_2006),
    "\n##### Variables: ",ncol(test_data_2006))
```

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

dplyr::anti_join(intermediate_data, 
                 test_data_2006, 
                 by = 'id') -> validate_data_2006

rm(intermediate_data)

cat("#### Validate Data ",
    "\n##### Observations: ",nrow(validate_data_2006),
    "\n##### Variables: ",ncol(validate_data_2006))
```

<br>


```{r}
mod_2006 <- lm(votos ~ quantidade_fornecedores * partido + media_despesa * partido +
                  total_receita * total_despesa + partido * estado_civil + 
                  recursos_de_outros_candidatos.comites * ocupacao +
                  uf * total_despesa + total_receita * partido +
                  recursos_de_partido_politico * partido + 
                  recursos_totais * quantidade_doadores +
                  total_despesa * partido  + 
                  uf * recursos_proprios ,
          data = train_data_2006)

broom::glance(mod_2006)
```

```{r}
broom::tidy(mod_2006,
            conf.int = TRUE,
            conf.level = 0.95)
```

<br>

# Linear Model for 2010 elections

<br>

## Split Data for Cross Validation

```{r}
eleicoes_data %>% ## Put numeric predictor variables on same scale 
   filter(ano == 2010) %>%
   mutate_at(.vars = vars(quantidade_doacoes,
                          quantidade_doadores,
                          recursos_totais,
                          total_receita,
                          media_receita,
                          sequencial_candidato,
                          recursos_de_outros_candidatos.comites,
                          recursos_de_pessoas_fisicas,
                          recursos_de_pessoas_juridicas,
                          recursos_proprios,
                          recursos_de_partido_politico,
                          quantidade_despesas,
                          quantidade_fornecedores,
                          total_despesa,
                          media_despesa),
             .funs = funs(as.numeric(scale(.)))) -> data_scaled_2010

data_scaled_2010 %>%
  sample_n(5)
```

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

## Adding surrogate key to dataframe
data_scaled_2010$id <- 1:nrow(data_scaled_2010)

data_scaled_2010 %>% 
  dplyr::sample_frac(.5) -> train_data_2010

cat("#### Train Data ",
    "\n##### Observations: ",nrow(train_data_2010),
    "\n##### Variables: ",ncol(train_data_2010))
```

<br>

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

dplyr::anti_join(data_scaled_2010, 
                 train_data_2010, 
                 by = 'id') -> intermediate_data

intermediate_data %>% 
  dplyr::sample_frac(.5) -> test_data_2010

cat("#### Test Data ",
    "\n##### Observations: ",nrow(test_data_2010),
    "\n##### Variables: ",ncol(test_data_2010))
```

```{r results='asis'}
set.seed(101) # We set the set for reason of reproducibility

dplyr::anti_join(intermediate_data, 
                 test_data_2010, 
                 by = 'id') -> validate_data_2010

rm(intermediate_data)

cat("#### Validate Data ",
    "\n##### Observations: ",nrow(validate_data_2010),
    "\n##### Variables: ",ncol(validate_data_2010))
```

<br>

```{r}
mod_2010 <- lm(votos ~ quantidade_fornecedores * partido + media_despesa * partido +
                  total_receita * total_despesa + partido * estado_civil + 
                  recursos_de_outros_candidatos.comites * ocupacao +
                  uf * total_despesa + total_receita * partido +
                  recursos_de_partido_politico * partido + 
                  recursos_totais * quantidade_doadores +
                  total_despesa * partido  + 
                  uf * recursos_proprios ,
          data = train_data_2010)
broom::glance(mod_2010)
```

```{r}
broom::tidy(mod_2010,
            conf.int = TRUE,
            conf.level = 0.95)
```

<br>

# Evaluating Models

## Overperforming predictors

```{r}
broom::tidy(mod_2006, 
     conf.int = TRUE, 
     conf.level = 0.95,
     sep=":") %>%
  filter(term != "(Intercept)") %>%
  mutate(term = gsub("[ ÚA-ZÁ,\\-\\(\\)ÀÃÂÊÉÔÔÓÕÍÇ]", "", term)) %>%
  mutate(term = gsub("\\:", " \\: ", term),
         abs_pval = abs(p.value)) %>%
  group_by(term) %>%
  arrange(desc(abs_pval)) %>%
  slice(1) %>%
  ungroup() %>%
  arrange(desc(abs_pval)) %>%
  slice(1:3) %>%
  ggplot(aes(reorder(term,p.value), p.value)) +
  geom_point(size = 2) +
  labs(x = "Predictor variable",
       y = "Estimated value (95% of confidence)")
```

```{r}
broom::tidy(mod_2010, 
     conf.int = TRUE, 
     conf.level = 0.95,
     sep=":") %>%
  filter(term != "(Intercept)") %>%
  mutate(term = gsub("[ ÚA-ZÁ,\\-\\(\\)ÀÃÂÊÉÔÔÓÕÍÇ]", "", term)) %>%
  mutate(term = gsub("\\:", " \\: ", term),
         abs_pval = abs(p.value)) %>%
  group_by(term) %>%
  arrange(desc(abs_pval)) %>%
  slice(1) %>%
  ungroup() %>%
  arrange(desc(abs_pval)) %>%
  slice(1:3) %>%
  ggplot(aes(reorder(term,p.value), p.value)) +
  geom_point(size=2) +
  labs(x = "Predictor variable",
       y = "Estimated value (95% of confidence)")
```

## Underperforming predictors

```{r}
broom::tidy(mod_2006, 
     conf.int = TRUE, 
     conf.level = 0.95,
     sep=":") %>%
  filter(term != "(Intercept)") %>%
  mutate(term = gsub("[ ÚA-ZÁ,\\-\\(\\)ÀÃÂÊÉÔÔÓÕÍÇ]", "", term)) %>%
  mutate(term = gsub("\\:", " \\: ", term),
         abs_pval = abs(p.value)) %>%
  group_by(term) %>%
  arrange(abs_pval) %>%
  slice(1) %>%
  ungroup() %>%
  arrange(abs_pval) %>%
  slice(1:3) %>%
  ggplot(aes(reorder(term,p.value), p.value)) +
  geom_hline(yintercept = 0.05, colour = "darkred") +
  geom_point(size = 2) +
  labs(x = "Predictor variable",
       y = "Estimated value (95% of confidence)")
```

```{r}
broom::tidy(mod_2010, 
     conf.int = TRUE, 
     conf.level = 0.95,
     sep=":") %>%
  filter(term != "(Intercept)") %>%
  mutate(term = gsub("[ ÚA-ZÁ,\\-\\(\\)ÀÃÂÊÉÔÔÓÕÍÇ]", "", term)) %>%
  mutate(term = gsub("\\:", " \\: ", term),
         abs_pval = abs(p.value)) %>%
  group_by(term) %>%
  arrange(abs_pval) %>%
  slice(1) %>%
  ungroup() %>%
  arrange(abs_pval) %>%
  slice(1:3) %>%
  ggplot(aes(reorder(term,p.value), p.value)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 0.05,
             colour = "darkred") +
  labs(x = "Predictor variable",
       y = "Estimated value (95% of confidence)")
```


## Residue Analysis

<br>

### Residual vs Fitted

```{r}
mod_2006 %>%
  ggplot(aes(.fitted, .resid)) + 
  geom_point() +
  stat_smooth(method="loess") + 
  geom_hline(col="red",
             yintercept=0,
             linetype="dashed") + 
  labs(y="Residuals",
       x="Fitted values",
       title="Residual vs Fitted Plot (2006)")
```

```{r}
mod_2010 %>%
  ggplot(aes(.fitted, .resid)) + 
  geom_point() +
  stat_smooth(method="loess") + 
  geom_hline(col="red",
             yintercept=0,
             linetype="dashed") + 
  labs(y="Residuals",
       x="Fitted values",
       title="Residual vs Fitted Plot (2010)")
```

### Normal Q-Q

```{r}
mod_2006 %>%
  ggplot(aes(sample=rstandard(.))) +
  stat_qq(na.rm = TRUE,
          shape=1,size=3) +      # open circles
  labs(title="Normal Q-Q (2006 elections)",        # plot title
  x="Theoretical Quantiles",      # x-axis label
  y="Standardized Residuals") +   # y-axis label +
  geom_abline(color = "red",
              size = 0.8,
              linetype="dashed")  # dashed reference line
```

```{r}
mod_2010 %>%
  ggplot(aes(sample=rstandard(.))) +
  stat_qq(na.rm = TRUE,
          shape=1,size=3) +      # open circles
  labs(title="Normal Q-Q (2010 elections)",        # plot title
  x="Theoretical Quantiles",      # x-axis label
  y="Standardized Residuals") +   # y-axis label +
  geom_abline(color = "red",
              size = 0.8,
              linetype="dashed")  # dashed reference line
```

### Scale-Location

```{r}
mod_2006 %>%
  ggplot(aes(.fitted, 
             sqrt(abs(.stdresid)))) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess",
              na.rm = TRUE) +
  labs(title = "Scale-Location (2006 elections)",
       x= "Fitted Value",
       y = expression(sqrt("|Standardized residuals|")))
```

```{r}
mod_2010 %>%
  ggplot(aes(.fitted, 
             sqrt(abs(.stdresid)))) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess",
              na.rm = TRUE) +
  labs(title = "Scale-Location (2010 elections)",
       x= "Fitted Value",
       y = expression(sqrt("|Standardized residuals|")))
```

### Residual vs Leverage Plot

```{r}
mod_2006 %>%
  ggplot(aes(.hat, .stdresid)) + 
  geom_point(aes(size=.cooksd), na.rm=TRUE) +
  stat_smooth(method="loess", na.rm=TRUE) +
  xlab("Leverage")+ylab("Standardized Residuals") + 
  ggtitle("Residual vs Leverage Plot (2006 elections)") + 
  scale_size_continuous("Cook's Distance", range=c(1,5)) +    
  theme(legend.position="bottom")
```

```{r}
mod_2010 %>%
  ggplot(aes(.hat, .stdresid)) + 
  geom_point(aes(size=.cooksd), na.rm=TRUE) +
  stat_smooth(method="loess", na.rm=TRUE) +
  xlab("Leverage")+ylab("Standardized Residuals") + 
  ggtitle("Residual vs Leverage Plot (2010 elections)") + 
  scale_size_continuous("Cook's Distance", range=c(1,5)) +    
  theme(legend.position="bottom")
```

### Cook's dist vs Leverage

```{r}
mod_2006 %>%
  ggplot(aes(.hat, .cooksd)) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess", na.rm=TRUE) + 
  xlab("Leverage hii")+ylab("Cook's Distance") + 
  ggtitle("Cook's dist vs Leverage hii/(1-hii) (2006 elections)") + 
  geom_abline(slope=seq(0,3,0.5), color="gray", linetype="dashed")
```

```{r}
mod_2010 %>%
  ggplot(aes(.hat, .cooksd)) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess", na.rm=TRUE) + 
  xlab("Leverage hii")+ylab("Cook's Distance") + 
  ggtitle("Cook's dist vs Leverage hii/(1-hii) (2010 elections)") + 
  geom_abline(slope=seq(0,3,0.5), color="gray", linetype="dashed")
```

